services:
  # Web Service - Handles API requests
  - type: web
    name: inboxv3-api
    env: python
    plan: starter  # Change to 'standard' or 'pro' for production
    buildCommand: pip install -r requirements.txt
    startCommand: gunicorn main:app -w ${GUNICORN_WORKERS:-4} -k uvicorn.workers.UvicornWorker --bind 0.0.0.0:$PORT --timeout 3600 --keep-alive 300 --max-requests 1000 --max-requests-jitter 50 --worker-connections 1000 --preload --graceful-timeout 30
    healthCheckPath: /health
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: GUNICORN_WORKERS
        value: 4
      - key: MAX_FILE_SIZE_MB
        value: 100
      - key: MAX_TOTAL_SIZE_MB
        value: 2000
      - key: MAX_FILES_PER_REQUEST
        value: 30
      - key: REQUEST_TIMEOUT_SECONDS
        value: 1800
      - key: PER_FILE_TIMEOUT_SECONDS
        value: 120
      # Add these secrets in Render dashboard (DO NOT put values here):
      # - OPENAI_API_KEY (required)
      # - SUPABASE_URL (required)
      # - SUPABASE_SERVICE_ROLE_KEY (required)
      # - OPENAI_MODEL (optional, defaults to gpt-4o)
      # - AWS_ACCESS_KEY_ID (optional, if using Textract)
      # - AWS_SECRET_ACCESS_KEY (optional, if using Textract)
      # - AWS_REGION (optional, if using Textract)
      # - ALLOWED_ORIGINS (optional, comma-separated CORS origins)

  # Background Worker - Processes jobs from database
  - type: worker
    name: inboxv3-worker
    env: python
    plan: starter  # Change to 'standard' or 'pro' for production
    buildCommand: pip install -r requirements.txt
    startCommand: python worker.py
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: WORKER_POLL_INTERVAL_SECONDS
        value: 5
      - key: REQUEST_TIMEOUT_SECONDS
        value: 1800
      - key: PER_FILE_TIMEOUT_SECONDS
        value: 120
      # Add these secrets in Render dashboard (same as web service):
      # - OPENAI_API_KEY (required)
      # - SUPABASE_URL (required)
      # - SUPABASE_SERVICE_ROLE_KEY (required)
      # - AWS_ACCESS_KEY_ID (optional, if using Textract)
      # - AWS_SECRET_ACCESS_KEY (optional, if using Textract)
      # - AWS_REGION (optional, if using Textract)
